Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2018-03-27T10:15:40+10:00

https://access.redhat.com/documentation/en-us/red_hat_certificate_system/9/html/managing_smart_cards_with_the_enterprise_security_client/

https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/managing_smart_cards/enabling-smart-card-login

https://access.redhat.com/articles/3034441 ← **Smartcard support in RHEL7.4**
yum install pcsc-lite sssd-common krb5-libs sssd-proxy gdm sssd-common-pac sssd-krb5-common pcsc-lite-ccid sssd-ipa pulseaudio-gdm-hooks coolkey sssd-ad pcsc-lite-libs sssd-ldap python-sssdconfig sssd-krb5 sssd authconfig-gtk krb5-workstation sssd-client authconfig

# ipa-advise config-server-for-smart-card-auth
# ipa-advise config-client-for-smart-card-auth

**LINK SMARTCARD CERT TO IDM USER ACC**
**IPA SERVER**
1 ADD DIRECTLY TO IPA USER ACC
A Extract the certificate from the smartcard
# yum install coreutils
# certutil -L -d /etc/pki/nssdb/ -h all
# certutil -L -d /etc/pki/nssdb/ -n 'my_certificate' -r | base64 -w 0 > user.crt
B Link User account to smartcard cert
# kinit admin
# cat cert.pem | tail -n +2 | head -n -1 | tr -d '\r\n' | ipa user-add-cert idm_user
C Remove link 
# ipa user-show idm_user
# ipa user-remove-cert idm_user --certificate MIIC3...

2 AD OPTIONS
1 Store user cert in AD user entry 
2 Store user cert in IPA using ID view

3 IDENTITY MAPPING (with or without access to smartcard)
Match process - selects the domain certificate or CA in the smart card cert
Map process - associate the cert to an IDM role/account


**IPA** **CLIENT HOST**
SELF SIGNED CERT
srv1# ipa-advise config-client-for-smart-card-auth > client_smart_card_script.sh
srv1# chmod +x client_smart_card_script.sh
client# ./client_smart_card_script.sh CA_cert.pem

EXTERNAL SIGNED CERT
# ipa-cacert-manage -n "SmartCard CA" -t CT,C,C install ca.pem
# ipa-certupdate
# systemctl restart httpd

SSH 
# ssh -I /usr/lib/libmypkcs11.so -l user@example.com host.example.com

**CLIENT WORKSTATION**
# yum install opensc 
# yum install esc ← Enterprise Security Client
# systemctl start pcscd.socket pcscd.service

**HOW THINGS WORK**
1 Phone Home - caches token information used by smart cards to authenticate
2 ESC collect Phone home or Global phone home and/or contacts the TPS(Token/Certificate server)

**SWITCH FROM COOLKEY TO OPENSC**
https://access.redhat.com/articles/3034441
1# vim /etc/pam_pkcs11/pam_pkcs11.conf
2# pkcs11-switch opensc
3# modutil -list -dbdir /etc/pki/nssdb/

**TROUBLESHOOTING**
https://access.redhat.com/articles/3034441
1# certutil -L -d /etc/pki/nssdb
2# modutil -list -dbdir [[/etc/pki/nssdb/]]
3# pklogin_finder debug
4# pkcs11_inspect debug

# opensc-tool --list-readers
# yubico-piv-tool -v -a status
# ykinfo -a
# opensc-tool -l
# pcsc_scan 
# lsusb -d 1050: -v

**DEBUG**
# systemctl stop pcscd; sudo LIBCCID_ifdLogLevel=0x000F pcscd --foreground --debug --apdu --color | tee log.txt
